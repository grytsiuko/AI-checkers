import random

from heuristics.generic_heuristic import GenericHeuristic
from training import random_generic_heuristic_weights, test_heuristics, random_pair


class GeneticAlgorithm:
    MAX_POPULATIONS = 10000
    MAX_INDIVIDUALS = 40
    # MUTATION_TIMES = 3
    STABILITY_PERCENTAGE = 0.95
    MUTATION_PROBABILITY = 0.015
    CROSSOVER_PROBABILITY = 0.2

    # 0.4 / (l*n) (l - elements of heuristic, n - individuals)
    # crossover with probability
    # in-place

    def __init__(self, init_weights=None, full=None):
        assert self.MAX_INDIVIDUALS % 4 == 0
        if full is not None:
            self.weights_list = full
        else:
            self.weights_list = self._init_weights(init_weights)
        self.current_population = 0
        self._file = None

    def start(self):
        while self.current_population < self.MAX_POPULATIONS:
            self._run_population()
            self.current_population = self.current_population + 1
        self._file = open('genetic_statistics.txt', 'a')
        self._write_statistics("\n\n\n### RESULT ###", self.weights_list, True)
        self._file.close()

    def _run_population(self):
        self._file = open('genetic_statistics.txt', 'a')
        self._write_statistics(f"### POPULATION {self.current_population} ###", self.weights_list, True)

        # get survivals
        random.shuffle(self.weights_list)
        best = self._get_half_best(self.weights_list)
        assert len(best) == self.MAX_INDIVIDUALS // 2

        self._write_statistics(f"Best", best)

        # get leader
        if self.current_population % 10 == 0 and self.current_population > 0:
            leaders = best
            while len(leaders) > 1:
                random.shuffle(leaders)
                leaders = self._get_half_best(leaders)
            assert len(leaders) == 1

            self._write_statistics(f"Leader", leaders, True)

        # init next population
        ancestors = self._populate_list_random(best, self.MAX_INDIVIDUALS)
        assert len(ancestors) == self.MAX_INDIVIDUALS

        # crossover
        random.shuffle(ancestors)
        after_crossover = []
        for i in range(0, self.MAX_INDIVIDUALS, 2):
            weights1 = ancestors[i]
            weights2 = ancestors[i + 1]
            new_weights1, new_weights2 = self._crossover_weights(weights1, weights2)
            after_crossover += [new_weights1, new_weights2]
        assert len(after_crossover) == self.MAX_INDIVIDUALS

        self._write_statistics(f"Crossed", after_crossover)

        # mutations
        after_mutations = []
        for i in range(0, self.MAX_INDIVIDUALS):
            to_mutate = after_crossover[i]
            after_mutations.append(self._mutate_weights(to_mutate))
        assert len(after_mutations) == self.MAX_INDIVIDUALS

        self._write_statistics(f"Mutated", after_mutations)

        self.weights_list = after_mutations
        self._file.close()

    def _populate_list_random(self, weights_list, amount):
        ans = []
        length = len(weights_list)
        for i in range(0, amount):
            index = random.randint(0, length - 1)
            ans.append(self._copy_list(weights_list[index]))
        return ans

    def _copy_list(self, weights):
        new_weights = []
        for w in weights:
            new_weights.append((w[0], w[1]))
        return new_weights

    def _write_statistics(self, title, weights, console=False):
        if console:
            print(title)
            for weight in weights:
                print(weight, ',')
            print()
        self._file.write(title + '\n')
        for weight in weights:
            self._file.write(str(weight) + ',\n')
        self._file.write('\n' + '\n')

    def _get_half_best(self, weights_list):
        best = []
        for i in range(0, len(weights_list), 2):
            h1 = GenericHeuristic(weights_list[i])
            if i + 1 == len(weights_list):
                best.append(weights_list[i])
                break
            h2 = GenericHeuristic(weights_list[i + 1])
            diff = test_heuristics(h1, h2)
            if diff > 0:
                best.append(weights_list[i])
            else:
                best.append(weights_list[i + 1])
        return best

    def _mutate_weights(self, weights):
        new_weights = []
        for w in weights:
            new0 = w[0]
            new1 = w[1]
            if random.random() < self.MUTATION_PROBABILITY:
                new0 = new0 * self.STABILITY_PERCENTAGE \
                       + random.uniform(GenericHeuristic.MIN_COEF, GenericHeuristic.MAX_COEF) * (
                               1 - self.STABILITY_PERCENTAGE)

            new_weights.append((new0, new1))
        return new_weights

    def _crossover_weights(self, weights1, weights2):
        if random.random() < (1 - self.CROSSOVER_PROBABILITY):
            return weights1, weights2

        center = random.randint(1, GenericHeuristic.PARAMETER_LIST_LENGTH - 1)
        new_weights1 = []
        new_weights2 = []

        for i in range(0, center):
            new_weights1.append((weights1[i][0], weights1[i][1]))
            new_weights2.append((weights2[i][0], weights2[i][1]))

        for i in range(center, GenericHeuristic.PARAMETER_LIST_LENGTH):
            new_weights2.append((weights1[i][0], weights1[i][1]))
            new_weights1.append((weights2[i][0], weights2[i][1]))

        assert len(new_weights1) == GenericHeuristic.PARAMETER_LIST_LENGTH
        return new_weights1, new_weights2

    def _init_weights(self, init_weights):
        ans = []
        if init_weights is None:
            while len(ans) < self.MAX_INDIVIDUALS:
                ans.append(random_generic_heuristic_weights())
        else:
            ans.append(init_weights)
            while len(ans) < self.MAX_INDIVIDUALS:
                ans.append(self._mutate_weights(init_weights))
        return ans


if __name__ == '__main__':
    starting = [
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1),
         (8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1),
         (-2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1),
         (-2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(8.951684887756823, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-4.888812373409372, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        8.476089053001576, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.777038793471533, 1), (5.713699114162813, 1), (-7.344087752542959, 1), (-4.214604474620019, 1), (
        11.921773506143182, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (5.120355909007214, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        7.885651781910113, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (4.199792028636541, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (7.1185541949311775, 1)],
        [(2.0281168631574777, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        5.664569540787496, 1), (6.335544698839435, 1), (-3.45849107717217, 1), (-6.177115184359085, 1), (
         -1.7015503148759437, 1), (3.639989883908497, 1), (0.9666934959878581, 1), (-2.117005453654863, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.777038793471533, 1), (5.713699114162813, 1), (-7.344087752542959, 1), (-4.214604474620019, 1), (
        11.921773506143182, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-2.6203379632823025, 1), (
         -2.811864486514211, 1), (5.120355909007214, 1), (4.199792028636541, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (7.1185541949311775, 1)],
        [(3.3861708242650352, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.983323341609449, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.204605486310406, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        5.664569540787496, 1), (6.335544698839435, 1), (-3.45849107717217, 1), (-8.416953510608652, 1), (
         -2.811864486514211, 1), (2.526807865677587, 1), (0.9666934959878581, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        7.885651781910113, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(1.5226063271640933, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (1.3145086400751593, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(3.3861708242650352, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.983323341609449, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.777038793471533, 1), (5.713699114162813, 1), (-7.344087752542959, 1), (-4.214604474620019, 1), (
        11.921773506143182, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (5.120355909007214, 1), (1.501131425382336, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (7.1185541949311775, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-3.2630441774363192, 1), (
        10.193050593653131, 1), (4.445671799702222, 1), (-7.229072326326474, 1), (-13.797113604281765, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(4.959584724965186, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -4.592305980182985, 1), (4.706273811528467, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (5.935377783298204, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -1.480432194866716, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        5.664569540787496, 1), (6.335544698839435, 1), (-3.45849107717217, 1), (-8.416953510608652, 1), (
         -5.277105937397652, 1), (2.526807865677587, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-0.6886623291569522, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.777038793471533, 1), (5.713699114162813, 1), (-7.344087752542959, 1), (-4.214604474620019, 1), (
        11.921773506143182, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (5.120355909007214, 1), (4.199792028636541, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (7.1185541949311775, 1)],
        [(8.951684887756823, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-4.888812373409372, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-5.704244034012266, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(4.959584724965186, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-3.2630441774363192, 1), (
        10.193050593653131, 1), (4.445671799702222, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -3.4051646762234355, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         0.5051312756036337, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        5.664569540787496, 1), (6.335544698839435, 1), (-3.45849107717217, 1), (-8.416953510608652, 1), (
         -2.811864486514211, 1), (2.526807865677587, 1), (0.9666934959878581, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-4.214604474620019, 1), (
        5.664569540787496, 1), (6.335544698839435, 1), (-3.45849107717217, 1), (-8.416953510608652, 1), (
         -2.811864486514211, 1), (2.526807865677587, 1), (0.9666934959878581, 1), (-1.8482799720770338, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(4.959584724965186, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-3.2630441774363192, 1), (
        10.193050593653131, 1), (5.225628406102958, 1), (-7.229072326326474, 1), (-13.797113604281765, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(4.959584724965186, 1), (12.983812561759486, 1), (-10.837031478154495, 1), (-3.2630441774363192, 1), (
        10.193050593653131, 1), (4.445671799702222, 1), (-7.229072326326474, 1), (-13.797113604281765, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (-4.051586109527646, 1), (-3.954296877512971, 1), (
         -2.0850776140827163, 1), (10.173339003906989, 1)],
        [(6.229768307199436, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-4.888812373409372, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(8.693455660325654, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-4.888812373409372, 1), (
        8.020382529483758, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.639989883908497, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(4.959584724965186, 1), (8.840953871248372, 1), (-10.837031478154495, 1), (-3.2630441774363192, 1), (
        10.193050593653131, 1), (4.445671799702222, 1), (-7.229072326326474, 1), (-13.797113604281765, 1), (
         1.0468563642216058, 1), (2.847699909461937, 1), (-0.5759192227233823, 1), (-2.931395755109109, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-6.652541722514432, 1), (-1.5942254940521263, 1), (
        7.885651781910113, 1), (6.335544698839435, 1), (-4.864894928225189, 1), (-6.177115184359085, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.097562621635996, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
        [(6.315401596750209, 1), (12.046179117866435, 1), (-7.344087752542959, 1), (-1.5942254940521263, 1), (
        9.146175702687415, 1), (11.205003175568088, 1), (-8.82781041161024, 1), (-6.182579335317071, 1), (
         -2.811864486514211, 1), (3.359151132141541, 1), (0.9666934959878581, 1), (-4.717102178598562, 1), (
         -2.5916545659210337, 1), (6.742538287779657, 1)],
    ]
    g = GeneticAlgorithm(full=starting)
    g.start()
